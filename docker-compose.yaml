version: '3.8'

services:
  nginx:
    restart: always
    image: trunkplayer/trunkplayer-ng-nginx:latest
    build: nginx/
    ports:
      - 8080:80
      - 8443:443
    depends_on:
      - gunicorn
    volumes:
      - ${STATIC_VOLUME_PATH}:/code/static
      - ${MEDIA_VOLUME_PATH}:/code/mediafiles

  trunk-player-frontend:
    restart: always
    image: trunkplayer/trunkplayer-ng-frontend:latest
    build: ../Trunk-PlayerNG-Frontend/
    environment:
      NEXT_PUBLIC_BASEAPIURL: "${NEXT_PUBLIC_BASEAPIURL}"
      NEXT_PUBLIC_RECOMMENDEDBASEAPIURL: "${NEXT_PUBLIC_RECOMMENDEDBASEAPIURL}"

  gunicorn:
    restart: always
    image: trunkplayer/trunkplayer-ng:latest
    build: .
    command: 
      - /bin/sh
      - '-c'
      - |
        sleep 5; \
        python -m gevent.monkey manage.py migrate && \
        python -m gevent.monkey manage.py createsuperuser --noinput; \
        python -m gevent.monkey manage.py collectstatic --no-input; \
        gunicorn -c trunkplayer_ng/gunicorn.conf.py
    env_file:
      - .env
    environment:
      DB_HOST: "database"
      PROMETHEUS_MULTIPROC_DIR: /opt/chaos.corp/tpng/metrics
      CELERY_BROKER_URL: "amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@rabbitmq:5672"
    volumes:
      - ${STATIC_VOLUME_PATH}:/opt/chaos.corp/tpng/static
      - ${MEDIA_VOLUME_PATH}:/opt/chaos.corp/tpng/mediafiles
      - metrics:/opt/chaos.corp/tpng/metrics
    depends_on:
      - database
      - rabbitmq

  trunk-player-worker:
    restart: always
    image: trunkplayer/trunkplayer-ng:latest
    build: .
    deploy:
      replicas: 2
    command: 
      - celery
      - '-A'
      - 'trunkplayer_ng'
      - 'worker'
      - '-l'
      - 'info'
      - '--pool'
      - 'gevent'
      - '--concurrency'
      - '100' 
      - '-E'
      - '-Q'
      - |-
        default,transmission_forwarding,radio_refrence,radio_alerts,transmission_ingest,tranmission_push
    env_file:
      - .env
    environment:
      DB_HOST: "database"
      PROMETHEUS_MULTIPROC_DIR: /opt/chaos.corp/tpng/metrics
      CELERY_BROKER_URL: "amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@rabbitmq:5672"
    volumes:
      - ${STATIC_VOLUME_PATH}:/opt/chaos.corp/tpng/static
      - ${MEDIA_VOLUME_PATH}:/opt/chaos.corp/tpng/mediafiles
      - metrics:/opt/chaos.corp/tpng/metrics
    depends_on:
      - database
      - rabbitmq

  trunk-player-beat:
    restart: always
    image: trunkplayer/trunkplayer-ng:latest
    build: .
    command:
      - celery
      - '-A'
      - 'trunkplayer_ng'
      - 'beat'
      - '-l'
      - 'info'
    env_file:
      - .env
    environment:
      DB_HOST: "database"
      PROMETHEUS_MULTIPROC_DIR: /opt/chaos.corp/tpng/metrics
      CELERY_BROKER_URL: "amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@rabbitmq:5672"
    volumes:
      - ${STATIC_VOLUME_PATH}:/opt/chaos.corp/tpng/static
      - ${MEDIA_VOLUME_PATH}:/opt/chaos.corp/tpng/mediafiles
      - metrics:/opt/chaos.corp/tpng/metrics
    depends_on:
      - database
      - rabbitmq

  database:
    image: postgres:latest
    restart: always
    environment:
      POSTGRES_PASSWORD: "${DB_PASS}"
      POSTGRES_DB: "${DB_NAME}"
      POSTGRES_USER: "${DB_USER}"
    volumes:
      - ${DATABASE_VOLUME_PATH}:/var/lib/postgresql/data

  rabbitmq:
    image: 'rabbitmq:management'
    restart: always
    ports:
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}
        
  
volumes:
  metrics: